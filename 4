@echo off
setlocal enabledelayedexpansion

:: üîπ D√©finition du dossier racine (MODIFIE AVEC TON CHEMIN)
set "BASE_DIR=C:\chemin\vers\ton\projet"

:: üîπ D√©tection automatique des applications Spring Boot avec une recherche r√©cursive
set "index=0"
for /r "%BASE_DIR%" %%D in (pom.xml) do (
    set "projectDir=%%~dpD"
    if exist "!projectDir!\config-local\application-dev.yml" (
        set /a index+=1
        set "appPath!index!=!projectDir!"

        :: üî∏ R√©cup√©rer le port depuis application-dev.yml
        set "port=NON-TROUV√â"
        for /f "tokens=2 delims=:" %%P in ('findstr /R "^server\.port" "!projectDir!\config-local\application-dev.yml" 2^>nul') do (
            set "port=%%P"
            set "port=!port: =!"  :: Supprimer les espaces
        )
        set "appPort!index!=%port%"

        :: üî∏ R√©cup√©rer le bon artifactId depuis pom.xml
        set "artifactId=NON-TROUV√â"
        set "foundProject=0"
        for /f "tokens=2 delims=<>" %%A in ('findstr /N "<artifactId>" "!projectDir!\pom.xml" 2^>nul') do (
            set "line=%%A"
            for /f "tokens=1 delims=:" %%B in ("!line!") do (
                set "lineNumber=%%B"
            )
            if !foundProject! == 0 (
                set "artifactId=%%A"
                set "foundProject=1"
            )
        )
        set "appName!index!=%artifactId%"

        echo !index! - !appName! (Port: !appPort!)
    )
)

if %index%==0 (
    echo ‚ùå Aucun projet Spring Boot trouv√© dans %BASE_DIR%.
    pause
    exit /b
)

:: üîπ Demander quelles applications d√©marrer
set /p "choices=Entrez les num√©ros des applications √† d√©marrer (ex: 1 3 5): "

:: üîπ Lancer les applications s√©lectionn√©es apr√®s un git pull
for %%i in (%choices%) do (
    if defined appPath%%i (
        set "appPath=!appPath%%i!"
        set "appPort=!appPort%%i!"
        set "appName=!appName%%i!"

        echo ================================
        echo üöÄ Lancement de !appName! sur le port !appPort!...
        echo ================================

        :: üîπ V√©rifier si c'est un repo Git et faire un pull
        if exist "!appPath!\.git" (
            echo üîÑ Mise √† jour de !appName! avec git pull...
            cd /d "!appPath!"
            git pull
            cd /d "%BASE_DIR%"
        ) else (
            echo ‚ö†Ô∏è  Pas de d√©p√¥t Git trouv√© pour !appName!, d√©marrage sans mise √† jour.
        )

        :: üîπ Lancer l'application apr√®s le git pull
        start "!appName!" cmd /k "cd /d !appPath! && mvn spring-boot:run -Dspring-boot.run.arguments=--server.port=!appPort!"
    ) else (
        echo ‚ùå Num√©ro %%i non valide, application ignor√©e.
    )
)

echo ‚úÖ Toutes les applications demand√©es sont en cours d'ex√©cution.
pause
