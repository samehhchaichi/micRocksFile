@echo off
setlocal enabledelayedexpansion

:: üîπ D√©finition du dossier racine (√† adapter selon ton projet)
set "BASE_DIR=C:\chemin\vers\ton\projet"

:: üîπ D√©tection automatique des applications Spring Boot bas√©es sur config-local/application-dev.yml
set "index=0"
for /d %%D in ("%BASE_DIR%\*") do (
    if exist "%%D\config\environnements\application-dev.yml" (
        set /a index+=1
        set "appPath!index!=%%D"

        :: üî∏ R√©cup√©rer le port depuis application-dev.yml
        set "port=NON-TROUV√â"
        for /f "tokens=2 delims=:" %%P in ('findstr "server.port" "%%D\config\environnements\application-dev.yml" 2^>nul') do (
            set "port=%%P"
            set "port=!port: =!"  :: Supprimer les espaces
        )
        set "appPort!index!=%port%"

        :: üî∏ R√©cup√©rer le bon artifactId depuis pom.xml
        set "artifactId=NON-TROUV√â"
        for /f "tokens=2 delims=<>" %%A in ('findstr "<artifactId>" "%%D\pom.xml" 2^>nul') do (
            if "!artifactId!"=="NON-TROUV√â" set "artifactId=%%A"
        )
        set "appName!index!=%artifactId%"

        echo !index! - %artifactId% (Port: %port%)
    )
)

if %index%==0 (
    echo ‚ùå Aucun projet Spring Boot d√©tect√© dans %BASE_DIR%.
    pause
    exit /b
)

:: üîπ Demander quelles applications d√©marrer
set /p "choices=Entrez les num√©ros des applications √† d√©marrer (ex: 1 3 5): "

:: üîπ Lancer les applications s√©lectionn√©es apr√®s un git pull
for %%i in (%choices%) do (
    if defined appPath%%i (
        set "appPath=!appPath%%i!"
        set "appPort=!appPort%%i!"
        set "appName=!appName%%i!"

        echo ================================
        echo üöÄ Lancement de !appName! sur le port !appPort!...
        echo ================================

        :: üîπ V√©rifier si c'est un repo Git
        if exist "!appPath!\.git" (
            echo üîÑ Mise √† jour de !appName! avec git pull...
            cd /d "!appPath!"
            git pull
            cd /d "%BASE_DIR%"
        ) else (
            echo ‚ö†Ô∏è  Pas de d√©p√¥t Git trouv√© pour !appName!, d√©marrage sans mise √† jour.
        )

        :: üîπ Lancer l'application apr√®s le git pull
        start "!appName!" cmd /k "cd /d !appPath! && mvn spring-boot:run -Dspring-boot.run.arguments=--server.port=!appPort!"
    ) else (
        echo ‚ùå Num√©ro %%i non valide, application ignor√©e.
    )
)

echo ‚úÖ Toutes les applications demand√©es sont en cours d'ex√©cution.
pause
